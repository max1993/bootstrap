/* Hadoop front end pipeline*/
var topRowsToExpand=localStorage.expandTaskLogs_topRowsToExpand||100,tasklogFilter=localStorage.expandTaskLogs_tasklogFilter||"syslog",offsetKB=localStorage.expandTaskLogs_offsetKB||1,updateIntervalSecs=localStorage.expandTaskLogs_updateIntervalSecs||30,jsonpProxyURL=localStorage.expandTaskLogs_jsonpProxyURL||"http://localhost:8001/?url=$url&format=text&jsonp=?";if(topRowsToExpand=prompt("How many rows do you want to expand from the top?\n You can click on individual rows to toggle them later.",topRowsToExpand)){localStorage.expandTaskLogs_topRowsToExpand=topRowsToExpand=parseInt(topRowsToExpand);var showError=function(){null!=window.updateLogsT&&(window.updateLogsT=clearTimeout(window.updateLogsT));console.error.apply(console,arguments);window.shownError||(alert("You may need to run a JSON-P proxy on your machine!\nInstall it by running:\n\n  git clone https://github.com/clintandrewhall/node-jsonp-proxy.git\n  cd node-jsonp-proxy\n  node server.js\n\n"),window.shownError=!0)},getPage=function(c,b){var d=setTimeout(showError,1E3*Math.max(30,0.9*updateIntervalSecs));if(c)return $.ajax({url:jsonpProxyURL.replace("$url",encodeURIComponent(c)),dataType:"jsonp",success:function(c,a){d=clearTimeout(d);return b(c,a)},error:showError});console.error("no url")},textMatch=function(c){return function(){return $(this).text().match(c)}},updateLogs=function(){function c(k,e,f){var g=e.closest("table"),c,b=c=$("a",e).filter(function(){return"Last 4KB"==$(this).text()}).first().attr("href");if(null!=b){var b=null==offsetKB?c.replace("start=-4097","all=true"):c.replace("start=-4097","start=-"+(Math.round(1024*offsetKB)+1)),b=b+("&filter="+tasklogFilter+"&plaintext=true"),a=$("thead tr,tr:nth(0)",g).first().find("td"),g=a.filter(textMatch(/Task Attempts|Task Id/i)).index(),a=a.filter(textMatch(/Machine|Host/i)).index(),g=e.find("td:nth("+g+")").text();e=e.find("td:nth("+a+")").contents().clone();f=f||g;console.log(f,g,e.text(),b);a="tasklog"+f.replace(/[^A-Za-z0-9_-]/g,"_");if(0==$("#"+a).length){var d=k.find("td").length;k.after("<tr class='tasklog'><td colspan='"+d+"' id='"+a+"' class='tasklog'><a><b class='title'></b></a> <small class='tasktracker'></small> <small class='timestamp'></small> <b class='status'></b><pre></pre></td></tr>")}var h=$("#"+a);h.find(".tasktracker").contents().remove();h.find(".tasktracker").append(e);h.find(".title").text((null!=offsetKB?"Last "+offsetKB+"KB of ":"Entire ")+tasklogFilter+" of "+g).attr("title",f).closest("a").attr("href",c.replace("start=-4097","&filter="+tasklogFilter));h.find(".status").text("(Loading...)");getPage(b,function(a){h.find(".status").text("");h.find(".timestamp").text((new Date).toLocaleString());h.find("pre").text(a);0==--l&&updateIntervalSecs&&(window.updateLogsT=setTimeout(updateLogs,1E3*updateIntervalSecs))})}}null!=window.updateLogsT&&(window.updateLogsT=clearTimeout(window.updateLogsT));var b=$("table").first(),d=0==b.find("a").filter(textMatch(/^Last 4KB$/)).length,j;if(0==$("#expandLogsUI").length){$("<style>").html("#expandLogsUI{background-color:#F9F862;border:1px solid #999;border-radius:10px;box-shadow:0px 5px 10px #333;padding: 10px;width:700px;position:fixed;top:10px;right:10px;opacity:0.25;}#expandLogsUI:hover{opacity:1;}#expandLogsUI + table{margin-top: 20px;}#expandLogsUI span{margin:auto 10px;}#expandLogsUI input,#expandLogsUI button,#expandLogsUI select{font-size:inherit;}tr{ background-color:#888;cursor:s-resize;}tr.expanded{background-color:initial;cursor:n-resize;}tr.tasklog{background-color:initial;cursor: initial;}.tasklog.status{color:#f30;}").appendTo("head");$("<div>").attr("id","expandLogsUI").append($("<span>").append($("<select>").attr("id","tasklogFilter").append($("<option>").text("stdout")).append($("<option>").text("stderr")).append($("<option>").text("syslog")).val(tasklogFilter).change(updateLogs).before($("<label>").attr("for","tasklogFilter").text("Expand ")))).append($("<span>").append($("<input>").attr("id","offsetKB").attr("size",5).val(offsetKB).change(updateLogs).before($("<label>").attr("for","offsetKB").text("tailing ")).after("KB"))).append($("<span>").append($("<input>").attr("id","updateIntervalSecs").attr("size",5).val(updateIntervalSecs).change(updateLogs).before($("<label>").attr("for","updateIntervalSecs").text("updating every ")).after("secs"))).append($("<span>").append($("<button>").attr("id","updateLogs").text("Refresh").click(updateLogs))).append("<hr>").append($("<div>").css("font-size","75%").append($("<input>").attr("id","jsonpProxyURL").attr("size",64).val(jsonpProxyURL).change(updateLogs).before($("<label>").attr("for","jsonpProxyURL").text("JSON-P Proxy URL: ")))).append($("<div>").css("font-size","50%").append("You need to run something like ").append($("<a>").attr("href","https://github.com/clintandrewhall/node-jsonp-proxy").text("node-jsonp-proxy")).append(" or ").append($("<a>").attr("href","https://gist.github.com/3364319").text("jsonp-proxy.py")).append(" to bypass same-origin policy and access all logs from your browser.")).insertBefore(b);var a=b.find("tbody:nth(0) > tr");d&&(a=a.filter(function(){return $(this).find("td:nth(0) a").length}));a.click(function(){var a=$(this);a.toggleClass("expanded");a.hasClass("expanded")?j.apply(this):a.next().hasClass("tasklog")&&a.next().remove()});topRowsToExpand&&(a=a.filter(":lt("+topRowsToExpand+")"));a.addClass("expanded")}var l=b.find("tr.expanded").length;localStorage.expandTaskLogs_jsonpProxyURL=jsonpProxyURL=$("#jsonpProxyURL").val();localStorage.expandTaskLogs_tasklogFilter=tasklogFilter=$("#tasklogFilter").val();localStorage.expandTaskLogs_offsetKB=offsetKB=parseFloat($("#offsetKB").val())||null;localStorage.expandTaskLogs_updateIntervalSecs=updateIntervalSecs=parseFloat($("#updateIntervalSecs").val())||null;d?(j=function(){var a=$(this),b=a.find("a").first(),f=b.text();getPage(b[0].href,function(b){b=$("table:first > tbody > tr:last",b);c(a,b,f)})},getPage(location.href,function(a){var c=$("table a",a);b.find("tr.expanded").each(function(){var a=$(this),b=a.find("a").first().text();a.contents().remove();a.append(c.filter(textMatch(b)).closest("tr").contents())});b.find("tr.expanded").each(j)})):(j=function(){var a=$(this);c(a,a)},b.find("tr.expanded").each(j))};if(window.$)updateLogs();else{var s=document.createElement("script");s.src="http://code.jquery.com/jquery-latest.min.js";document.body.appendChild(s);s.onload=updateLogs}};